name: Build Algorithm

on: 
  push:
    branches:
      - 'satisfiability/*'
      - 'vehicle_routing/*'
      - 'knapsack/*'
      - 'test/satisfiability/*'
      - 'test/vehicle_routing/*'
      - 'test/knapsack/*'
      - 'dev/satisfiability/*'
      - 'dev/vehicle_routing/*'
      - 'dev/knapsack/*'

jobs:
  build_wasm:
    name: Compile Algorithm to Aarch64
    runs-on: ${{ !github.event.repository.private && 'ubuntu-24.04-arm' || 'self-hosted' }}
    permissions:
      contents: write
      statuses: write
    steps:
      - uses: actions/checkout@v4
      - name: Set Env Vars
        run: |
          CHALLENGE=`echo $GITHUB_REF_NAME | rev | cut -d/ -f2 | rev`
          ALGORITHM=`echo $GITHUB_REF_NAME | rev | cut -d/ -f1 | rev`
          if [ -f tig-algorithms/lib/${CHALLENGE}/${ALGORITHM}.tar.gz ]; then
            echo "SKIP_JOB=true" >> $GITHUB_ENV
          else
            echo "SKIP_JOB=false" >> $GITHUB_ENV
          fi
          echo "CHALLENGE=$CHALLENGE" >> $GITHUB_ENV
          echo "ALGORITHM=$ALGORITHM" >> $GITHUB_ENV

      - name: Build Algorithm
        if: env.SKIP_JOB != 'true'
        run: |
          docker run --rm --user root \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e CHALLENGE=${{ env.CHALLENGE }} \
            -e ALGORITHM=${{ env.ALGORITHM }} \
            ghcr.io/tig-foundation/tig-monorepo/dev:0.0.1-aarch64 \
            bash -c "RUST_TARGET=aarch64-unknown-linux-gnu \
            LD_LIBRARY_PATH=\${LD_LIBRARY_PATH}:/usr/local/lib/rust \
            build_so.sh \$CHALLENGE \$ALGORITHM && \
            cd tig-algorithms/lib/\${CHALLENGE} && \
            tar -czf \${ALGORITHM}.tar.gz aarch64/\${ALGORITHM}.so && \
            rm -rf aarch64"

      - name: Add safe directory
        run: |
          git config --global --add safe.directory $(realpath .)

      - name: Auto commit
        if: env.SKIP_JOB != 'true'
        id: auto_commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Compiled ${{ env.CHALLENGE }}/${{ env.ALGORITHM }}
          file_pattern: tig-algorithms/lib/${{ env.CHALLENGE }}/${{ env.ALGORITHM }}.tar.gz

      - name: Update Commit Status (Success)
        if: env.SKIP_JOB != 'true' && success()
        uses: myrotvorets/set-commit-status-action@master
        with:
          status: 'success'
          sha: ${{ steps.auto_commit.outputs.commit_hash }}

      - name: Update Commit Status (Failure)
        if: env.SKIP_JOB != 'true' && failure()
        uses: myrotvorets/set-commit-status-action@master
        with:
          status: 'failure'
